{% if page.toc %}
<div  class="toc-wrapper">
  <h2 class="toc-title">목차</h2>
    <nav class="toc-nav">
      {% include toc.html html=content h_min=2 h_max=3 skipNoIDs=true class="toc" %}
  </nav>
</div>
<script>
  (function () {
    const tocNav = document.querySelector(".toc-nav");
    if (!tocNav) return;

    const links = Array.from(tocNav.querySelectorAll('a[href^="#"]'));
    if (links.length === 0) return;

    const ids = links
      .map((link) => {
        const href = link.getAttribute("href") || "";
        const rawId = href.startsWith("#") ? href.slice(1) : "";
        try {
          return decodeURIComponent(rawId);
        } catch (_) {
          return rawId;
        }
      })
      .filter(Boolean);

    const headings = ids
      .map((id) => document.getElementById(id))
      .filter((el) => el && (el.tagName === "H2" || el.tagName === "H3"));

    if (headings.length === 0) return;

    const linkById = new Map();
    links.forEach((link) => {
      const href = link.getAttribute("href") || "";
      if (!href.startsWith("#")) return;
      const rawId = href.slice(1);
      let id = rawId;
      try {
        id = decodeURIComponent(rawId);
      } catch (_) {}
      linkById.set(id, link);
    });

    const orderedIds = headings
      .slice()
      .sort((a, b) => a.getBoundingClientRect().top - b.getBoundingClientRect().top)
      .map((h) => h.id);

    let activeId = null;

    function setActive(id) {
      if (!id || id === activeId) return;
      if (activeId && linkById.get(activeId)) {
        linkById.get(activeId).classList.remove("is-active");
      }
      const next = linkById.get(id);
      if (next) next.classList.add("is-active");
      activeId = id;
    }

    function updateActive() {
      const focusOffset = Math.min(window.innerHeight * 0.25, 180);
      let current = orderedIds[0];

      for (const id of orderedIds) {
        const heading = document.getElementById(id);
        if (!heading) continue;
        const top = heading.getBoundingClientRect().top;
        if (top - focusOffset <= 0) current = id;
        else break;
      }

      setActive(current);
    }

    let ticking = false;
    function onScroll() {
      if (ticking) return;
      ticking = true;
      window.requestAnimationFrame(() => {
        updateActive();
        ticking = false;
      });
    }

    window.addEventListener("scroll", onScroll, { passive: true });
    window.addEventListener("resize", updateActive);

    updateActive();
    window.setTimeout(updateActive, 0);
  })();
</script>
{% endif %}
